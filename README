# HBAR–DOGE Mean Reversion & Bollinger Bot

[![CI](https://github.com/savvaniss/mean-pair/actions/workflows/ci.yml/badge.svg)](https://github.com/savvaniss/mean-pair/actions/workflows/ci.yml)

A modular cryptocurrency trading bot that implements **mean reversion** for the HBAR/DOGE ratio and **Bollinger Band** strategies for single trading pairs. The backend is built with FastAPI, Python, and SQLAlchemy. Docker Compose wires the app to PostgreSQL by default, while local development can still point `DATABASE_URL` at SQLite. The lightweight HTML/JavaScript dashboard lives in `static/`. A full pytest suite and GitHub Actions CI pipeline keep the project validated in development.

---

## Key Functionality

### Mean Reversion Bot (HBAR ↔ DOGE)

- Trades the ratio `HBARUSDC / DOGEUSDC` to capitalize on reversion toward the rolling mean.
- Rolling statistics and signals:
  - Mean, standard deviation, and z-score
  - Entry/exit thresholds (`z_entry` and `z_exit`) with optional fixed ratio thresholds
- Maintains internal portfolio state:
  - Current asset and quantity
  - Realized and unrealized PnL
- Full trade logging plus manual trade support for discretionary entries/exits.
- Works on Binance testnet or mainnet, controlled through environment variables.

### Single-Coin Bollinger Bot

- Trades any supported symbol vs USDC, USDT, or BTC (e.g., `BNBUSDC`, `ETHUSDT`).
- Bollinger Band calculation with moving average, standard deviation, and upper/lower bands.
- Configurable parameters: window size, band width, maximum position size, stop-loss/take-profit, cooldown interval.
- Tracks quote balance, asset quantity, and realized/unrealized PnL.
- Detailed trade history and a manual exit endpoint for risk control.

### Shared Platform Features

- FastAPI service exposing JSON endpoints for both strategies.
- Centralized configuration management in `config.py` with per-bot settings.
- SQLAlchemy-backed state and logging handled via `database.py` (SQLite by default; PostgreSQL supported).
- Single-page dashboard for live monitoring, manual control, and charting.
- Listing monitor that aggregates new coin/pair launches across Binance, major CEXs, and DEX aggregators.
- Docker and docker-compose for reproducible deployments.

---

## Dashboard

The HTML/JavaScript dashboard (served from `/`) provides:

- Live status for both bots, including balances, prices, and PnL
- Mean-reversion ratio charts and Bollinger price/band charts
- Inline configuration editor for both strategies
- Manual trading controls and quick status toggles
- Trade history tables for auditing decisions

Static assets live in `static/` and are served directly by FastAPI.

The `/listings` page provides a live feed of new listings with filters by exchange type (CEX/DEX), exchange name, network, search, and time window. A JSON API (`/api/listings/latest`) powers the table and can be consumed programmatically.

---

## Project Structure

```
mean-pair/
├── app.py                   # FastAPI application setup and route registration
├── config.py                # Default configuration and helper utilities
├── database.py              # Database helpers and initialization (SQLAlchemy)
├── engines/                 # Trading logic implementations
│   ├── bollinger.py         # Bollinger Band strategy engine
│   ├── common.py            # Shared helpers (pricing, stats, risk controls)
│   └── mean_reversion.py    # HBAR/DOGE mean-reversion engine
├── routes/                  # FastAPI routers
│   ├── bollinger.py         # Bollinger API routes
│   ├── mean_reversion.py    # Mean reversion API routes
│   └── trading.py           # Shared trading endpoints
├── static/                  # Front-end dashboard assets
│   ├── css/
│   ├── js/
│   └── index.html
├── tests/                   # Pytest suite covering logic and APIs
├── .github/workflows/ci.yml # GitHub Actions CI (linting/tests)
├── Dockerfile               # Container build for the FastAPI service
└── docker-compose.yml       # Local stack orchestration
```

---

## Environment Variables

Provided via `.env`:

```
# Mean Reversion bot keys
BINANCE_TESTNET_API_KEY=
BINANCE_TESTNET_API_SECRET=
BINANCE_MAINNET_API_KEY=
BINANCE_MAINNET_API_SECRET=

# Bollinger bot keys (optional)
BINANCE_BOLL_TESTNET_API_KEY=
BINANCE_BOLL_TESTNET_API_SECRET=
BINANCE_BOLL_MAINNET_API_KEY=
BINANCE_BOLL_MAINNET_API_SECRET=

# Environment: "testnet" or "mainnet"
ENV=testnet

# Internal flags (used by CI)
BOT_DISABLE_THREADS=0
DISABLE_BINANCE_CLIENT=0
LISTINGS_DISABLE_SCHEDULER=0
LISTINGS_REFRESH_SECONDS=60
LISTINGS_RETENTION_MINUTES=240
AUTH_ALLOW_REGISTRATION=1

# Database
# Docker Compose injects this Postgres URL by default; override to SQLite locally if desired
DATABASE_URL=postgresql+psycopg2://meanpair:meanpair@db:5432/meanpair
```

Set `AUTH_ALLOW_REGISTRATION=0` to disable self-service sign-up and restrict access to pre-created accounts only.

---

## Running Locally

Install dependencies:

```
pip install -r requirements.txt
```

Start the development server:

```
uvicorn app:app --reload
```

Open the dashboard:

```
http://localhost:8000
```

---

## Running with Docker

Build and start the stack:

```
docker-compose up --build -d
```

Services:
- FastAPI app: http://localhost:8000
- PostgreSQL database: exposed inside the Docker network at `db:5432` (default `DATABASE_URL`)
- Nginx Proxy Manager (if enabled): http://localhost:81

---

## API Endpoints

### Mean Reversion

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/status` | Current MR bot status (prices, ratio, PnL) |
| GET | `/next_signal` | Predict next MR trade action |
| GET | `/config` | Get MR config |
| POST | `/config` | Update MR config |
| POST | `/start` | Start MR bot loop |
| POST | `/stop` | Stop MR bot loop |
| POST | `/manual_trade` | Execute manual HBAR↔DOGE trade (specify `from_asset_qty` or `notional_usd`) |
| GET | `/trades` | List MR trades |

### Bollinger

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/boll_config` | Get Bollinger config |
| POST | `/boll_config` | Update Bollinger config |
| GET | `/boll_status` | Current Bollinger status |
| GET | `/boll_history` | Band/MA/price history |
| GET | `/boll_trades` | List Bollinger trades |
| POST | `/bollinger_manual_sell` | Manual exit trade |
| GET | `/symbols_grouped` | Binance symbols grouped by quote asset |

### Listings Monitor

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/listings/latest` | Latest normalized listings with filters for exchange/network/time window |
| GET | `/api/listings/health` | Health/last run details for each collector |
| GET | `/listings` | UI that renders the listings table and filters |

---

## Adding New Algorithms (e.g., PatternRecognition and Strategy001)

The app can host additional strategies like the two Freqtrade examples below. To wire them in, mirror the existing engines and routers:

1. **Create an engine module** under `engines/` that wraps the algorithm's signal logic (e.g., talib pattern recognition or EMA/Heikin Ashi crossover). Follow the structure in `engines/bollinger.py` or `engines/trend_following.py`: maintain state objects, expose `start_*_thread()`/`stop_*_thread()` helpers, and guard exchange calls with `config.BOT_DISABLE_THREADS` / `DISABLE_BINANCE_CLIENT` flags.
2. **Add a FastAPI router** in `routes/` that surfaces config and status endpoints for the new engine (see `routes/trend_following.py` as a template). Include endpoints to toggle `enabled`, set symbol/timeframe, and expose recent signals so the frontend can display them.
3. **Register the strategy** in `app.py`: import the new engine and router, include the router with `auth_required`, and start/stop the background thread inside the `startup`/`shutdown` events alongside the other bots.
4. **Persist snapshots/trades** by extending `database.py` with new SQLAlchemy models similar to `TrendSnapshot`/`TrendTrade` so you can chart signals and PnL. Reuse helpers in `engines/common.py` for price fetching, sizing, and rounding.
5. **Update the dashboard** in `static/` if you need a dedicated view. You can copy the Bollinger chart/table widgets and point them at the new API routes.
6. **Backfill tests** in `tests/` to validate indicator calculations and API responses. Use fixtures like `mock_binance_client` and flags such as `DISABLE_BINANCE_CLIENT=1` to keep tests offline.

For the provided snippets:

- *PatternRecognition* uses `talib` pattern-recognition functions on daily candles. Feed it OHLCV data (from Binance klines or your DB), calculate the chosen pattern column in `populate_indicators`, and generate `enter_long`/`exit_long` flags similar to `populate_entry_trend`.
- *Strategy001* trades 5m EMA crossovers with Heikin Ashi candles. The engine should stream 5m prices, compute `ema20/ema50/ema100` plus HA candles, and issue market orders when the crossover/HA conditions flip.

---

## Testing & CI

Run all tests locally:

```
pytest
```

GitHub Actions builds run on every push and pull request via `.github/workflows/ci.yml`, using the following flags to disable live Binance access:

```
DISABLE_BINANCE_CLIENT=1
BOT_DISABLE_THREADS=1
```

The CI badge at the top of this README reflects the latest build status.

---

## Roadmap

- Split monolithic `app.py` into modules
- Add async DB writer
- Add historical backtester
- Improve Bollinger trend filters
- Add WebSocket price streaming
- Extend charting system in UI

---

## License

MIT License © 2025 Savvaniss
