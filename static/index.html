<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Strategy Desk</title>
  <link rel="stylesheet" href="css/theme.css" />
  <script src="https://unpkg.com/vue@3.4.29/dist/vue.global.prod.js"></script>
</head>
<body>
  <div id="app" class="page" v-cloak>
    <header class="topbar">
      <div class="identity">
        <div class="dot"></div>
        <div>
          <p class="eyebrow">Mean Pair Desk</p>
          <h1>Serene Strategy Console</h1>
        </div>
      </div>
      <div class="top-actions">
        <span class="muted">Auto refresh every {{ refreshSeconds }}s</span>
        <button class="ghost" @click="refreshAll">Refresh now</button>
      </div>
    </header>

    <section class="strip" aria-label="Overview">
      <div class="pill" v-if="overview.pair">
        <span>Pair</span>
        <strong>{{ overview.pair }}</strong>
      </div>
      <div class="pill" v-if="overview.wallet">
        <span>Wallet</span>
        <strong>{{ overview.wallet }}</strong>
      </div>
      <div class="pill" v-if="overview.pnl">
        <span>Realized PnL</span>
        <strong>{{ overview.pnl }}</strong>
      </div>
      <div class="pill" v-if="overview.mode">
        <span>Mode</span>
        <strong>{{ overview.mode }}</strong>
      </div>
      <div class="pill">
        <span>Status</span>
        <strong>{{ heartbeat }}</strong>
      </div>
    </section>

    <main class="layout">
      <section class="column">
        <div class="section-header">
          <div>
            <p class="eyebrow">Mean Reversion</p>
            <h2>Spread Navigator</h2>
          </div>
          <div class="cluster">
            <button class="ghost" @click="applyBest('mr')">Apply best</button>
            <button class="ghost" @click="openConfig('mr')">Configure</button>
            <button class="primary" @click="toggleRun('mr', true)">Start</button>
            <button class="ghost" @click="toggleRun('mr', false)">Stop</button>
          </div>
        </div>
        <div class="pane">
          <div class="pane-block">
            <div class="pane-title">Current status</div>
            <dl class="stats">
              <div v-for="row in displayMeta(mr.status)" :key="row.label">
                <dt>{{ row.label }}</dt>
                <dd>{{ row.value }}</dd>
              </div>
            </dl>
          </div>
          <div class="pane-block">
            <div class="pane-title">Next signal</div>
            <dl class="stats">
              <div v-for="row in displayMeta(mr.next)" :key="row.label">
                <dt>{{ row.label }}</dt>
                <dd>{{ row.value }}</dd>
              </div>
            </dl>
            <div class="compact-actions">
              <button class="ghost" @click="syncState">Sync balances</button>
            </div>
          </div>
        </div>
        <div class="pane">
          <div class="pane-block">
            <div class="pane-title">Manual trade</div>
            <form class="inline-form" @submit.prevent="submitManualMean">
              <label>Direction
                <select v-model="mr.manual.direction">
                  <option v-for="option in mr.directions" :key="option" :value="option">{{ option.replace('->',' â†’ ') }}</option>
                </select>
              </label>
              <label>Notional (USD)
                <input type="number" step="0.01" v-model.number="mr.manual.notional" placeholder="100" />
              </label>
              <label>Quantity (from asset)
                <input type="number" step="0.0001" v-model.number="mr.manual.qty" placeholder="0.1" />
              </label>
              <div class="compact-actions">
                <button type="submit" class="primary">Send trade</button>
              </div>
            </form>
          </div>
          <div class="pane-block scroll">
            <div class="pane-title">History</div>
            <table v-if="mr.history.length" class="data-table">
              <thead><tr><th>TS</th><th>Ratio</th><th>Z</th></tr></thead>
              <tbody>
                <tr v-for="row in mr.history" :key="row.ts">
                  <td>{{ row.ts }}</td><td>{{ row.ratio }}</td><td>{{ row.z }}</td>
                </tr>
              </tbody>
            </table>
            <p class="muted" v-else>No data</p>
          </div>
          <div class="pane-block scroll">
            <div class="pane-title">Trades</div>
            <table v-if="mr.trades.length" class="data-table">
              <thead><tr><th>TS</th><th>Side</th><th>Qty</th><th>PnL</th></tr></thead>
              <tbody>
                <tr v-for="row in mr.trades" :key="row.ts + row.side">
                  <td>{{ row.ts }}</td><td>{{ row.side }}</td><td>{{ row.qty }}</td><td>{{ row.pnl }}</td>
                </tr>
              </tbody>
            </table>
            <p class="muted" v-else>No trades</p>
          </div>
          <div class="pane-block scroll">
            <div class="pane-title">Pair scan</div>
            <table v-if="mr.pairs.length" class="data-table">
              <thead><tr><th>Pair</th><th>Samples</th><th>Last z</th></tr></thead>
              <tbody>
                <tr v-for="row in mr.pairs" :key="row.pair">
                  <td>{{ row.pair }}</td><td>{{ row.samples }}</td><td>{{ row.z }}</td>
                </tr>
              </tbody>
            </table>
            <p class="muted" v-else>No pairs</p>
          </div>
        </div>
      </section>

      <section class="column">
        <div class="section-header">
          <div>
            <p class="eyebrow">Bollinger</p>
            <h2>Band Runner</h2>
          </div>
          <div class="cluster">
            <button class="ghost" @click="applyBest('boll')">Apply best</button>
            <button class="ghost" @click="openConfig('boll')">Configure</button>
            <button class="primary" @click="toggleRun('boll', true)">Start</button>
            <button class="ghost" @click="toggleRun('boll', false)">Stop</button>
          </div>
        </div>
        <div class="pane">
          <div class="pane-block">
            <div class="pane-title">Status</div>
            <dl class="stats">
              <div v-for="row in displayMeta(boll.status)" :key="row.label">
                <dt>{{ row.label }}</dt><dd>{{ row.value }}</dd>
              </div>
            </dl>
          </div>
          <div class="pane-block">
            <div class="pane-title">Manual sell</div>
            <form class="inline-form" @submit.prevent="submitBollinger">
              <label>Symbol
                <select v-model="boll.manual.symbol">
                  <option v-for="s in boll.symbols" :key="s" :value="s">{{ s }}</option>
                </select>
              </label>
              <label>Quantity (base)
                <input type="number" step="0.0001" v-model.number="boll.manual.qty" />
              </label>
              <div class="compact-actions">
                <button type="submit" class="primary">Sell</button>
              </div>
            </form>
          </div>
          <div class="pane-block scroll">
            <div class="pane-title">History</div>
            <table v-if="boll.history.length" class="data-table">
              <thead><tr><th>TS</th><th>Price</th><th>Upper</th><th>Lower</th></tr></thead>
              <tbody>
                <tr v-for="row in boll.history" :key="row.ts + row.price">
                  <td>{{ row.ts }}</td><td>{{ row.price }}</td><td>{{ row.upper }}</td><td>{{ row.lower }}</td>
                </tr>
              </tbody>
            </table>
            <p class="muted" v-else>No data</p>
          </div>
          <div class="pane-block scroll">
            <div class="pane-title">Trades</div>
            <table v-if="boll.trades.length" class="data-table">
              <thead><tr><th>TS</th><th>Side</th><th>Qty</th><th>PnL</th></tr></thead>
              <tbody>
                <tr v-for="row in boll.trades" :key="row.ts + row.side">
                  <td>{{ row.ts }}</td><td>{{ row.side }}</td><td>{{ row.qty }}</td><td>{{ row.pnl }}</td>
                </tr>
              </tbody>
            </table>
            <p class="muted" v-else>No trades</p>
          </div>
        </div>

        <div class="section-header">
          <div>
            <p class="eyebrow">Trend</p>
            <h2>Channel Walker</h2>
          </div>
          <div class="cluster">
            <button class="ghost" @click="openConfig('trend')">Configure</button>
            <button class="primary" @click="toggleRun('trend', true)">Start</button>
            <button class="ghost" @click="toggleRun('trend', false)">Stop</button>
          </div>
        </div>
        <div class="pane">
          <div class="pane-block">
            <div class="pane-title">Status</div>
            <dl class="stats">
              <div v-for="row in displayMeta(trend.status)" :key="row.label">
                <dt>{{ row.label }}</dt><dd>{{ row.value }}</dd>
              </div>
            </dl>
          </div>
          <div class="pane-block scroll">
            <div class="pane-title">History</div>
            <table v-if="trend.history.length" class="data-table">
              <thead><tr><th>TS</th><th>Price</th><th>MA</th></tr></thead>
              <tbody>
                <tr v-for="row in trend.history" :key="row.ts + row.price">
                  <td>{{ row.ts }}</td><td>{{ row.price }}</td><td>{{ row.ma }}</td>
                </tr>
              </tbody>
            </table>
            <p class="muted" v-else>No data</p>
          </div>
        </div>
      </section>

      <section class="column">
        <div class="section-header">
          <div>
            <p class="eyebrow">Relative Strength</p>
            <h2>Momentum Gauge</h2>
          </div>
          <div class="cluster">
            <button class="ghost" @click="openConfig('rs')">Configure</button>
            <button class="primary" @click="toggleRun('rs', true)">Start</button>
            <button class="ghost" @click="toggleRun('rs', false)">Stop</button>
          </div>
        </div>
        <div class="pane">
          <div class="pane-block">
            <div class="pane-title">Status</div>
            <dl class="stats">
              <div v-for="row in displayMeta(rs.status)" :key="row.label">
                <dt>{{ row.label }}</dt><dd>{{ row.value }}</dd>
              </div>
            </dl>
          </div>
          <div class="pane-block scroll">
            <div class="pane-title">History</div>
            <table v-if="rs.history.length" class="data-table">
              <thead><tr><th>TS</th><th>Price</th><th>Score</th></tr></thead>
              <tbody>
                <tr v-for="row in rs.history" :key="row.ts + row.price">
                  <td>{{ row.ts }}</td><td>{{ row.price }}</td><td>{{ row.score }}</td>
                </tr>
              </tbody>
            </table>
            <p class="muted" v-else>No data</p>
          </div>
        </div>

        <div class="section-header">
          <div>
            <p class="eyebrow">Trading Desk</p>
            <h2>Direct Order</h2>
          </div>
        </div>
        <div class="pane">
          <div class="pane-block">
            <form class="inline-form" @submit.prevent="submitTrade">
              <label>Account
                <input type="text" v-model="trading.form.account" placeholder="binance" />
              </label>
              <label>Mode
                <select v-model="trading.form.use_testnet">
                  <option :value="'true'">Testnet</option>
                  <option :value="'false'">Mainnet</option>
                </select>
              </label>
              <label>Symbol
                <input type="text" v-model="trading.form.symbol" placeholder="BTCUSDT" />
              </label>
              <label>Side
                <select v-model="trading.form.side">
                  <option value="buy">Buy</option>
                  <option value="sell">Sell</option>
                </select>
              </label>
              <label>Quantity (base)
                <input type="number" step="0.0001" v-model.number="trading.form.qty" />
              </label>
              <div class="compact-actions">
                <button type="submit" class="primary">Submit order</button>
              </div>
            </form>
          </div>
          <div class="pane-block scroll">
            <div class="pane-title">Balances</div>
            <div class="balance" v-for="acc in trading.balances" :key="acc.account">
              <header>
                <strong>{{ acc.account.toUpperCase() }}</strong>
                <span class="muted">{{ acc.use_testnet ? 'Testnet' : 'Mainnet' }}</span>
              </header>
              <div v-if="acc.error" class="small-note">{{ acc.error }}</div>
              <dl v-else class="stats slim">
                <div v-for="bal in acc.balances" :key="bal.asset">
                  <dt>{{ bal.asset }}</dt><dd>{{ bal.free }} / {{ bal.locked }}</dd>
                </div>
              </dl>
            </div>
          </div>
        </div>

        <div class="section-header">
          <div>
            <p class="eyebrow">Liquidation Hunt</p>
            <h2>Cluster Monitor</h2>
          </div>
          <div class="cluster">
            <button class="ghost" @click="openConfig('liq')">Configure</button>
            <button class="ghost" @click="runLiquidation('scan')">Scan</button>
            <button class="primary" @click="runLiquidation('execute')">Execute</button>
          </div>
        </div>
        <div class="pane">
          <div class="pane-block">
            <div class="pane-title">Status</div>
            <dl class="stats">
              <div v-for="row in displayMeta(liq.status)" :key="row.label">
                <dt>{{ row.label }}</dt><dd>{{ row.value }}</dd>
              </div>
            </dl>
          </div>
        </div>
      </section>
    </main>

    <transition name="fade">
      <div class="toast" v-if="toast.visible" :class="{ error: toast.error }">{{ toast.message }}</div>
    </transition>

    <div class="modal" v-if="modals.mr">
      <div class="modal-body">
        <header><h3>Mean reversion config</h3><button class="ghost" @click="closeConfig">Close</button></header>
        <form class="modal-form" @submit.prevent="saveConfig('mr')">
          <label v-if="mr.config.available_pairs?.length">Trading pair
            <select v-model="mr.config.pairSelection">
              <option v-for="pair in mr.config.available_pairs" :key="pair[0] + pair[1]" :value="pair[0] + '|' + pair[1]">{{ pair[0] }}/{{ pair[1] }}</option>
            </select>
          </label>
          <label v-for="(value, key) in mr.config.fields" :key="key">{{ key }}
            <select v-if="isBoolean('mr', key)" v-model="mr.config.fields[key]">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
            <textarea v-else-if="isArray('mr', key)" v-model="mr.config.fields[key]" rows="2"></textarea>
            <input v-else :type="inputType('mr', key)" v-model="mr.config.fields[key]" />
          </label>
          <div class="compact-actions">
            <button type="submit" class="primary">Save</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal" v-if="modals.boll">
      <div class="modal-body">
        <header><h3>Bollinger config</h3><button class="ghost" @click="closeConfig">Close</button></header>
        <form class="modal-form" @submit.prevent="saveConfig('boll')">
          <label v-for="(value, key) in boll.config.fields" :key="key">{{ key }}
            <select v-if="isBoolean('boll', key)" v-model="boll.config.fields[key]">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
            <textarea v-else-if="isArray('boll', key)" v-model="boll.config.fields[key]" rows="2"></textarea>
            <input v-else :type="inputType('boll', key)" v-model="boll.config.fields[key]" />
          </label>
          <div class="compact-actions"><button type="submit" class="primary">Save</button></div>
        </form>
      </div>
    </div>

    <div class="modal" v-if="modals.trend">
      <div class="modal-body">
        <header><h3>Trend config</h3><button class="ghost" @click="closeConfig">Close</button></header>
        <form class="modal-form" @submit.prevent="saveConfig('trend')">
          <label v-for="(value, key) in trend.config.fields" :key="key">{{ key }}
            <select v-if="isBoolean('trend', key)" v-model="trend.config.fields[key]">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
            <textarea v-else-if="isArray('trend', key)" v-model="trend.config.fields[key]" rows="2"></textarea>
            <input v-else :type="inputType('trend', key)" v-model="trend.config.fields[key]" />
          </label>
          <div class="compact-actions"><button type="submit" class="primary">Save</button></div>
        </form>
      </div>
    </div>

    <div class="modal" v-if="modals.rs">
      <div class="modal-body">
        <header><h3>Relative strength config</h3><button class="ghost" @click="closeConfig">Close</button></header>
        <form class="modal-form" @submit.prevent="saveConfig('rs')">
          <label v-for="(value, key) in rs.config.fields" :key="key">{{ key }}
            <select v-if="isBoolean('rs', key)" v-model="rs.config.fields[key]">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
            <textarea v-else-if="isArray('rs', key)" v-model="rs.config.fields[key]" rows="2"></textarea>
            <input v-else :type="inputType('rs', key)" v-model="rs.config.fields[key]" />
          </label>
          <div class="compact-actions"><button type="submit" class="primary">Save</button></div>
        </form>
      </div>
    </div>

    <div class="modal" v-if="modals.liq">
      <div class="modal-body">
        <header><h3>Liquidation config</h3><button class="ghost" @click="closeConfig">Close</button></header>
        <form class="modal-form" @submit.prevent="saveConfig('liq')">
          <label v-for="(value, key) in liq.config.fields" :key="key">{{ key }}
            <select v-if="isBoolean('liq', key)" v-model="liq.config.fields[key]">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
            <textarea v-else-if="isArray('liq', key)" v-model="liq.config.fields[key]" rows="2"></textarea>
            <input v-else :type="inputType('liq', key)" v-model="liq.config.fields[key]" />
          </label>
          <div class="compact-actions"><button type="submit" class="primary">Save</button></div>
        </form>
      </div>
    </div>
  </div>

  <script src="js/main.js"></script>
</body>
</html>
